# å¿«é€Ÿå¼€å§‹æŒ‡å—

## 5åˆ†é’Ÿä½“éªŒFuxiçŸ­URLç³»ç»Ÿ

### å‰ç½®è¦æ±‚

- Go 1.21+
- Makeå·¥å…·
- curlæˆ–å…¶ä»–HTTPå®¢æˆ·ç«¯

### ç¬¬ä¸€æ­¥ï¼šç”ŸæˆçŸ­URLæ•°æ®

```bash
make generate
```

è¾“å‡ºç¤ºä¾‹ï¼š
```
ç”ŸæˆçŸ­URLæ•°æ®æ–‡ä»¶...
å¼€å§‹ç”Ÿæˆ 1000000 æ¡çŸ­URL...
å¸ƒéš†è¿‡æ»¤å™¨å¤§å°: 10000000
ç”Ÿæˆå®Œæˆï¼Œè€—æ—¶: 2.3s
å¹³å‡é€Ÿåº¦: 434782 URLs/ç§’
å†™å…¥æ–‡ä»¶: data/shorturls.dat
å†™å…¥å®Œæˆï¼Œè€—æ—¶: 456ms
æ–‡ä»¶å¤§å°: 5.72 MB

=== ç¤ºä¾‹çŸ­URL (å‰10ä¸ª) ===
1: Kj8mP2
2: xR3nQ7
3: Yt5pL9
4: mN2kD4
5: Bv7wX1
...
```

### ç¬¬äºŒæ­¥ï¼šå¯åŠ¨APIæœåŠ¡

```bash
make run
```

è¾“å‡ºç¤ºä¾‹ï¼š
```
åˆå§‹åŒ–FuxiçŸ­URLæœåŠ¡...
æ•°æ®åº“: data/fuxi.db
ç¼“å­˜å¤§å°: 100000
é¢„åŠ è½½é“¾è¡¨åˆå§‹åŒ–å®Œæˆï¼Œå½“å‰æ•°é‡: 10000
æœåŠ¡å™¨å¯åŠ¨åœ¨ http://localhost:8080

APIæ–‡æ¡£:
  POST http://localhost:8080/api/shorten - ç”ŸæˆçŸ­URL
  GET  http://localhost:8080/api/stats   - ç»Ÿè®¡ä¿¡æ¯
  GET  http://localhost:8080/:code       - çŸ­URLé‡å®šå‘
```

### ç¬¬ä¸‰æ­¥ï¼šæµ‹è¯•API

æ‰“å¼€æ–°ç»ˆç«¯ï¼Œè¿è¡Œæµ‹è¯•è„šæœ¬ï¼š

```bash
./scripts/test.sh
```

æˆ–è€…æ‰‹åŠ¨æµ‹è¯•ï¼š

#### 1. åˆ›å»ºçŸ­URL

```bash
curl -X POST http://localhost:8080/api/shorten \
  -H "Content-Type: application/json" \
  -d '{"long_url":"https://github.com/golang/go"}'
```

å“åº”ï¼š
```json
{
  "short_code": "Kj8mP2",
  "short_url": "http://localhost:8080/Kj8mP2",
  "long_url": "https://github.com/golang/go"
}
```

#### 2. è®¿é—®çŸ­URLï¼ˆé‡å®šå‘ï¼‰

```bash
curl -I http://localhost:8080/Kj8mP2
```

å“åº”ï¼š
```
HTTP/1.1 302 Found
Location: https://github.com/golang/go
...
```

#### 3. æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯

```bash
curl http://localhost:8080/api/stats
```

å“åº”ï¼š
```json
{
  "total_urls": 5,
  "active_urls": 5,
  "expired_urls": 0,
  "total_access": 12,
  "cache_hit_rate": "85.71%",
  "preload_count": 9995
}
```

### ç¬¬å››æ­¥ï¼šè¿è¡Œæ€§èƒ½æµ‹è¯•

```bash
make stress
```

è¾“å‡ºç¤ºä¾‹ï¼š
```
=== Fuxi æ€§èƒ½æµ‹è¯• ===
ç›®æ ‡: http://localhost:8080
å¹¶å‘: 100
è¯·æ±‚: 10000

>>> æµ‹è¯•1: åˆ›å»ºçŸ­URL
æ€»è¯·æ±‚æ•°: 10000
æˆåŠŸ: 10000, å¤±è´¥: 0
æ€»è€—æ—¶: 12.3s
QPS: 813.01
å»¶è¿Ÿç»Ÿè®¡:
  æœ€å°: 2.1ms
  å¹³å‡: 8.5ms
  P50:  7.2ms
  P95:  15.8ms
  P99:  28.3ms
  æœ€å¤§: 45.6ms

>>> æµ‹è¯•2: çŸ­URLé‡å®šå‘
é¢„åˆ›å»ºäº† 1000 ä¸ªçŸ­URL
æ€»è¯·æ±‚æ•°: 10000
æˆåŠŸ: 10000, å¤±è´¥: 0
æ€»è€—æ—¶: 4.2s
QPS: 2380.95
å»¶è¿Ÿç»Ÿè®¡:
  æœ€å°: 0.8ms
  å¹³å‡: 3.2ms
  P50:  2.9ms
  P95:  6.1ms
  P99:  11.2ms
  æœ€å¤§: 18.4ms
```

---

## å¸¸ç”¨å‘½ä»¤

```bash
# æŸ¥çœ‹å¸®åŠ©
make help

# è¿è¡Œå•å…ƒæµ‹è¯•
make test

# è¿è¡ŒåŸºå‡†æµ‹è¯•
make benchmark

# æŸ¥çœ‹æ•°æ®æ–‡ä»¶
make inspect

# æŸ¥çœ‹æœåŠ¡å™¨ç»Ÿè®¡
make stats

# æ¸…ç†æ•°æ®
make clean

# æž„å»ºäºŒè¿›åˆ¶æ–‡ä»¶
make build
```

---

## ç›®å½•ç»“æž„

```
fuxi/
â”œâ”€â”€ cmd/
â”‚   â”œâ”€â”€ generator/main.go    # çŸ­URLç”Ÿæˆå·¥å…·
â”‚   â”œâ”€â”€ api/main.go         # APIæœåŠ¡å™¨
â”‚   â””â”€â”€ benchmark/main.go   # æ€§èƒ½æµ‹è¯•å·¥å…·
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ generator/          # ç”Ÿæˆç®—æ³•
â”‚   â”œâ”€â”€ preload/           # é¢„åŠ è½½é“¾è¡¨
â”‚   â””â”€â”€ storage/           # å­˜å‚¨å±‚
â”œâ”€â”€ test/                  # æµ‹è¯•ä»£ç 
â”œâ”€â”€ data/                  # æ•°æ®æ–‡ä»¶
â”‚   â”œâ”€â”€ shorturls.dat      # çŸ­URLæ•°æ®
â”‚   â”œâ”€â”€ offset.dat         # åç§»é‡
â”‚   â””â”€â”€ fuxi.db           # SQLiteæ•°æ®åº“
â”œâ”€â”€ Makefile              # Makeå‘½ä»¤
â”œâ”€â”€ README.md            # é¡¹ç›®è¯´æ˜Ž
â”œâ”€â”€ TECH_BLOG.md        # æŠ€æœ¯åšå®¢
â””â”€â”€ QUICKSTART.md       # æœ¬æ–‡æ¡£
```

---

## æ ¸å¿ƒæ¦‚å¿µé€Ÿè§ˆ

### 1. é¢„ç”Ÿæˆç­–ç•¥

ç³»ç»Ÿå¯åŠ¨å‰ï¼Œé¢„å…ˆç”Ÿæˆ100ä¸‡æ¡çŸ­URLå­˜å‚¨åœ¨æ–‡ä»¶ä¸­ï¼Œé¿å…è¿è¡Œæ—¶å†²çªå’Œå¯é¢„æµ‹æ€§é—®é¢˜ã€‚

```go
// éšæœºç”Ÿæˆ + å¸ƒéš†è¿‡æ»¤å™¨åŽ»é‡
gen := generator.NewGenerator(bloomSize)
urls, _ := gen.Generate(1000000)
```

### 2. é¢„åŠ è½½é“¾è¡¨

å¯åŠ¨æ—¶åŠ è½½10000æ¡çŸ­URLåˆ°å†…å­˜é“¾è¡¨ï¼Œå‰©ä½™ä¸è¶³2000æ—¶è‡ªåŠ¨å¼‚æ­¥åŠ è½½ä¸‹ä¸€æ‰¹ã€‚

```go
linkedURL.Init()           // åˆå§‹åŠ è½½10000æ¡
code, _ := linkedURL.Acquire()  // èŽ·å–ä¸€æ¡
// è‡ªåŠ¨è§¦å‘å¼‚æ­¥åŠ è½½
```

### 3. åç§»é‡æ–‡ä»¶äº’æ–¥

ä½¿ç”¨æ–‡ä»¶é”ä¿è¯å¤šä¸ªæœåŠ¡å™¨ä¸ä¼šåŠ è½½ç›¸åŒçš„çŸ­URLã€‚

```go
syscall.Flock(fd, syscall.LOCK_EX)  // ç‹¬å é”
// è¯»å–åç§»é‡ â†’ åŠ è½½æ•°æ® â†’ æ›´æ–°åç§»é‡
syscall.Flock(fd, syscall.LOCK_UN)  // é‡Šæ”¾é”
```

### 4. åˆ†å±‚ç¼“å­˜

```
è¯·æ±‚ â†’ LRUç¼“å­˜ï¼ˆå‘½ä¸­çŽ‡80%+ï¼‰â†’ SQLiteæ•°æ®åº“ â†’ è¿”å›ž
```

---

## æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡ | å®žæµ‹ | çŠ¶æ€ |
|------|------|------|------|
| ç”Ÿæˆé€Ÿåº¦ | >10ä¸‡/ç§’ | 43ä¸‡/ç§’ | âœ“ |
| åˆ›å»ºQPS | >500 | 813 | âœ“ |
| é‡å®šå‘QPS | >1000 | 2380 | âœ“ |
| ç¼“å­˜å‘½ä¸­çŽ‡ | >80% | 85.7% | âœ“ |
| P99å»¶è¿Ÿ | <50ms | 28.3ms | âœ“ |

---

## ä¸‹ä¸€æ­¥

- ðŸ“– é˜…è¯»[æŠ€æœ¯åšå®¢](TECH_BLOG.md)äº†è§£è®¾è®¡åŽŸç†
- ðŸ” æŸ¥çœ‹[æºç ](internal/)ç†è§£å®žçŽ°ç»†èŠ‚
- ðŸ§ª è¿è¡Œ[æµ‹è¯•](test/)éªŒè¯æ€§èƒ½
- ðŸ“Š å¯¹æ¯”ä¸åŒç”Ÿæˆç®—æ³•çš„ä¼˜åŠ£

---

## å¸¸è§é—®é¢˜

**Q: ä¸ºä»€ä¹ˆç”Ÿæˆ100ä¸‡æ¡ï¼Ÿ**  
A: ç­‰æ¯”ç¼©å°æŽæ™ºæ…§åŽŸè®¾è®¡çš„144äº¿æ¡ï¼Œä¾¿äºŽæœ¬åœ°éªŒè¯ã€‚

**Q: å¦‚ä½•æ‰©å±•åˆ°ç”Ÿäº§çŽ¯å¢ƒï¼Ÿ**  
A: å‚è€ƒ[æŠ€æœ¯åšå®¢](TECH_BLOG.md)ç¬¬ä¸ƒç« "ä»Žæœ¬åœ°åˆ°åˆ†å¸ƒå¼"ã€‚

**Q: æ€§èƒ½ç“¶é¢ˆåœ¨å“ªï¼Ÿ**  
A: SQLiteçš„å•çº¿ç¨‹å†™å…¥é™åˆ¶ã€‚ç”Ÿäº§çŽ¯å¢ƒåº”ä½¿ç”¨PostgreSQLæˆ–HBaseã€‚

**Q: ç¼“å­˜å‘½ä¸­çŽ‡å¦‚ä½•æå‡ï¼Ÿ**  
A: å¢žåŠ ç¼“å­˜å¤§å°ï¼ˆ-cacheå‚æ•°ï¼‰ï¼Œæˆ–ä½¿ç”¨Redisæ›¿ä»£å†…å­˜ç¼“å­˜ã€‚

---

## GitHubä»“åº“

é¡¹ç›®åœ°å€ï¼š[https://github.com/d60-Lab/shorturl](https://github.com/d60-Lab/shorturl)

## è´¡çŒ®

æ¬¢è¿Žæäº¤Issueå’ŒPull Requestï¼

- ðŸ› å‘çŽ°Bugï¼Ÿæäº¤Issue
- ðŸ’¡ æœ‰æ”¹è¿›å»ºè®®ï¼Ÿæäº¤Issueè®¨è®º
- ðŸ”§ æƒ³è´¡çŒ®ä»£ç ï¼ŸForkåŽæäº¤PR

## License

MIT License
